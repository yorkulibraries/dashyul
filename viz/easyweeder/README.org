#+TITLE: Easy Weeder
#+AUTHOR: William Denton

* About

TODO: Explain what this does.

* Generating all circ metrics, taking volumes into account

#+BEGIN_SRC R :session R:easyweeder :results values :colnames yes
library(tidyverse)

symphony_metrics_data_dir <-  paste0(Sys.getenv("DASHYUL_DATA"), "/symphony/metrics/")

easyweeder_data_dir <-  paste0(Sys.getenv("DASHYUL_DATA"), "/viz/easyweeder/")

circ_metrics <- read_csv(paste0(symphony_metrics_data_dir, "circ-metrics.csv"))

circ_window_years <- 5
#+END_SRC

#+RESULTS:
|   |

#+BEGIN_SRC R :session R:easyweeder :results values :colnames yes
how_many_copies_should_we_have <- function(copies = NULL, circs = NULL) {
    if (circs == 0) { return(1) }
    ## Calculate a vector of all possible busy values
    ## for all possible numbers of copies, and then
    ## the first one where busy >= 0.5.  The index
    ## of that leads to the number of copies we want.
    possible_copies <- seq(copies, 1)
    possible_busy <- circs / possible_copies / circ_window_years
    possible_busy_in_range <- which(possible_busy >= 0.5)
    if (length(possible_busy_in_range) > 0) {
        index_of_recommended_copies <- max(possible_busy_in_range)
        return(possible_copies[index_of_recommended_copies])
    } else {
        return(1)
    }
}

## scott <- circ_metrics %>% filter(home_location == "SCOTT", copies > 1, busy <= 0.5)

steacie_weedable <-  circ_metrics %>% filter(home_location == "STEACIE", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

bronfman_weedable <- circ_metrics %>% filter(home_location == "BRONFMAN", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

frost_weedable <- circ_metrics %>% filter(home_location == "BRONFMAN", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

scott_weedable <- circ_metrics %>% filter(home_location == "SCOTT", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

easily_weedable <-  circ_metrics %>% filter(copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

write(easily_weedable, paste0(easyweeder_data_dir, "easily-weedable.csv"))
#+END_SRC

#+RESULTS:
|   |

* Examples

+ [[https://www.library.yorku.ca/find/Record/1000076][A systolic array parallelizing compiler / Ping-Sheng Tseng]]: acquired in 1990, 0 circs.
+ https://www.library.yorku.ca/find/Record/1438201 Two vols, neither circed, but it's not two copies of the same item.
+ [[https://www.library.yorku.ca/find/Record/1172][Captains of consciousness : advertising and the social roots of the consumer culture]], copies at three branches

The volumes problem.



* Commands

+ ~make~ :: ???
+ ~make push_app~ :: use locally to push the Shiny app up to production

* Installation

This is run locally once a year and pushed into production, so there is no cron job.
