#+TITLE: Easy Weeder
#+AUTHOR: William Denton

#+OPTIONS: num:nil ^:{} toc:nil

#+LATEX_HEADER: \usepackage[T1]{fontenc}
#+LATEX_HEADER: \hypersetup{colorlinks=true,urlcolor=blue,linkcolor=blue,pdfborder={0 0 0}}
#+LATEX_HEADER: \usepackage[english]{babel} % English language/hyphenation

#+STARTUP: latexpreview

* About

TODO: Explain what this does.

* How it works

** "Busy factor"

What we know:

+ number of copies
+ number of circs of all those copies in the circ window
+ length of circ window (5 years)

We can combine these into a measure of "circs per copy per year," or how many times a year (on average, over the last five years) each copy of a title circulates.

Define the /busy factor/ to be number of circs divided by number of copies divided by length in years of the circ window.

#+name: eqn:1
\begin{equation}
busy = \frac{\frac{circs}{copies}}{years}
\end{equation}

Some examples:

| circs | copies | window | busy |
|-------+--------+--------+------|
|     5 |      1 |      5 |    1 |
|    10 |      1 |      5 |    2 |
|     2 |      1 |      5 |  0.4 |
|     1 |      2 |      5 |  0.4 |
|     2 |     19 |      5 | 0.02 |
|     2 |    698 |      5 | 69.8 |

(The last two are real examples: Francis Bacon's [[https://www.library.yorku.ca/find/Record/567179][Advancement of learning, and New Atlantis]] has a busy factor of 0.02, and [[https://www.library.yorku.ca/find/Record/2914459][Economics: Canada in the Global Environment]] is at 69.8, probably because it used to be on reserve but is now in the stacks).

** Logic

#+NAME: logic
#+BEGIN_SRC ditaa :file logic-flow.png :cmdline -r

+----------------+
|                |   +---+   +-----------+
|  busy ≥ 0.5?   +---+yes+---+do not weed|
|                |   +---+   +-----------+
+-----+----------+
      |
    +-++
    |no|
    ++-+
     |
+----+-------------+
|                  |
| how many copies? +
|                  |
+-+---+------------+
  |   |
  | +-+-+   +----------+
  | + 1 +---+do nothing|
  | +---+   +----------+
  |
+-+-+   +--------------------------------------+
+ 2 +---+ calculate maximum number (≥ 1) of    |
+---+   | copies to raise busy factor to ≥ 0.5 |
        +--------------------------------------+
#+END_SRC

#+CAPTION: Easy Weeder logic
#+LABEL: fig:logic
#+RESULTS: logic
[[file:logic-flow.png]]

To revisit the examples above, three are ignored because their busy factor is >= 0.5.  For the remaining three we can calculate the recommended number of copies we should keep.

For the one with 19 copies, and 2 circs, the calculation goes:

+ 19 copies is too many.  What if we had 18? Busy factor: 0.022.
+ 18 copies is too many.  What if we had 17? Busy factor: 0.024.
+ …
+ 6 copies is too many.  What if we had 5?  Busy factor: 0.08.
+ 5 copies is too many.  What if we had 4?  Busy factor: 0.1.
+ 4 copies is too many.  What if we had 3?  Busy factor: 0.133.
+ 3 copies is too many.  What if we had 2?  Busy factor: 0.2.
+ 2 copies is too many. Keep 1 copy.

As it happens, for all three we end up keeping just one copy.

| circs | copies | window length | busy factor | recommended |
|-------+--------+---------------+-------------+-------------|
|     2 |      1 |             5 |         0.4 |           1 |
|     1 |      2 |             5 |         0.4 |           1 |
|     2 |     19 |             5 |        0.02 |           1 |

But, for example, let's say we had a book that had six copies and 12 circs over the last five years, for a busy factor of 0.4.  We would end up keeping 4 copies.

+ 6 copies is too many.  What if we had 5? Busy factor: 0.48.
+ 5 copies is too many.  What if we had 4? Busy factor: 0.6
+ Keep 4 copies.  (4 is the largest number leading to a busy factor >= 0.5.  Keeping 3 would lead to a busy factor of 0.8, but 3 < 4.)

* Generating all circ metrics, taking volumes into account

#+BEGIN_SRC R :session R:easyweeder :results values :colnames yes
library(tidyverse)

symphony_metrics_data_dir <-  paste0(Sys.getenv("DASHYUL_DATA"), "/symphony/metrics/")

easyweeder_data_dir <-  paste0(Sys.getenv("DASHYUL_DATA"), "/viz/easyweeder/")

circ_metrics <- read_csv(paste0(symphony_metrics_data_dir, "circ-metrics.csv"))

circ_window_years <- 5
#+END_SRC

#+RESULTS:
| x |
|---|
| 5 |

#+BEGIN_SRC R :session R:easyweeder :results values :colnames yes
how_many_copies_should_we_have <- function(copies = NULL, circs = NULL) {
    if (circs == 0) { return(1) }
    ## Calculate a vector of all possible busy values
    ## for all possible numbers of copies, and then
    ## the first one where busy >= 0.5.  The index
    ## of that leads to the number of copies we want.
    possible_copies <- seq(copies, 1)
    possible_busy <- circs / possible_copies / circ_window_years
    possible_busy_in_range <- which(possible_busy >= 0.5)
    if (length(possible_busy_in_range) > 0) {
        index_of_recommended_copies <- max(possible_busy_in_range)
        return(possible_copies[index_of_recommended_copies])
    } else {
        return(1)
    }
}

## scott <- circ_metrics %>% filter(home_location == "SCOTT", copies > 1, busy <= 0.5)

steacie_weedable <-  circ_metrics %>% filter(home_location == "STEACIE", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

bronfman_weedable <- circ_metrics %>% filter(home_location == "BRONFMAN", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

frost_weedable <- circ_metrics %>% filter(home_location == "BRONFMAN", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

scott_weedable <- circ_metrics %>% filter(home_location == "SCOTT", copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

easily_weedable <-  circ_metrics %>% filter(copies > 1, busy <= 0.5) %>% rowwise() %>% mutate(rec_copies = how_many_copies_should_we_have(copies, circs_in_window), weedable = copies - rec_copies)

write_csv(easily_weedable, paste0(easyweeder_data_dir, "easily-weedable.csv"))
#+END_SRC

#+RESULTS:
|   |

* Examples

+ [[https://www.library.yorku.ca/find/Record/1000076][A systolic array parallelizing compiler / Ping-Sheng Tseng]]: acquired in 1990, 0 circs.
+ https://www.library.yorku.ca/find/Record/1438201 Two vols, neither circed, but it's not two copies of the same item.
+ [[https://www.library.yorku.ca/find/Record/1172][Captains of consciousness : advertising and the social roots of the consumer culture]], copies at three branches

The volumes problem.



* Commands

+ ~make~ :: ???
+ ~make push_app~ :: use locally to push the Shiny app up to production

* Installation

This is run locally once a year and pushed into production, so there is no cron job.
