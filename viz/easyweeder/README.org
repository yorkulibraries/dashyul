#+TITLE: Easy Weeder
#+AUTHOR: William Denton

* About

TODO: Explain what this does.

* Generating all circ metrics, taking volumes into account

#+BEGIN_SRC R :session R:easyweeder :results values :colnames yes
library(tidyverse)

ezweeder_data_dir <-  paste0(Sys.getenv("DASHYUL_DATA"), "/viz/easyweeder/")
ezweeder_checkouts <- read_csv(paste0(ezweeder_data_dir, "easyweeder-checkouts.csv"), col_types = "cci")
ezweeder_items     <- read_csv(paste0(ezweeder_data_dir, "easyweeder-items.csv"), col_types = "cccdccci")
ezweeder_titles    <- read_csv(paste0(ezweeder_data_dir, "easyweeder-titles.csv"), col_types = "ccc")

## Only consider books acquired over five years ago, i.e. in academic year 2012 or earlier.
## acquired_before <- 2013
## No, this isn't the right way to handle it.
## But at some point acquisition year needs to be handled.
## TODO: Handle acquisition year.

## items_in_range <- ezweeder_items ## %>% filter(home_location == "BRONFMAN", item_type == "BRONF-BOOK", lc_letters == "HF")
## items_in_range <- items_in_range %>% filter(acq_ayear < acquired_before)

items_in_range <- ezweeder_items

items_and_checkouts_in_range <- left_join(items_in_range, ezweeder_checkouts, by = "item_barcode")

## Window for considering circ metrics, like circs per year.
## 5 should mean "in the last five years before this year", e.g.
## during a2017 that means a2012, a2013, a2014, a2015, a2016 and a2017
## up to current.
circ_window_years <- 5
circ_window_ayear <- academic_year(Sys.Date()) - circ_window_years

## Circ details for each item, grouped by year.  One row for each item each year it circed (and one row if it didn't).
item_circ_history <- items_and_checkouts_in_range %>% mutate(has_circed = ! is.na(circ_ayear)) %>% group_by(item_barcode, control_number, call_number, home_location, item_type, circ_ayear) %>% summarise(circs = sum(has_circed))

## Circ details for each item at a higher level: total circs and year last circed.  One row for each item.
## Grouping in item_circ_history makes the mutation work.
item_circ_summary <- item_circ_history %>% mutate(item_last_circed_ayear = max(circ_ayear)) %>% group_by(item_barcode, control_number, call_number, home_location, item_last_circed_ayear) %>% summarise(total_circs = sum(circs))
item_circ_summary$item_last_circed_ayear[is.na(item_circ_summary$item_last_circed_ayear)] <- "0"

## Create the circ metrics data frame, which we'll add to.
## Here, for each control number, in each location, show the number of copies, total circs, and year of last circ.
circ_metrics <- item_circ_summary %>% group_by(control_number, call_number, home_location) %>% summarise(copies = n(), total_circs = sum(total_circs), last_circed_ayear = max(item_last_circed_ayear))

## Next, take a step aside to set up circs_per_copy data.  We will add this to circ_metrics.

## First, count total number of circs (in the circ window) for all items with the same control number and call number
## This lets us distinguish multiple volumes in a set (which each have different call numbers, ending e.g. in v1, v2, v3)
## from multiple copies of the same edition (which all have the same call number)
call_number_circs_in_window <- item_circ_history %>% filter(circ_ayear >= circ_window_ayear) %>% group_by(control_number, call_number, home_location) %>% summarise(circs_in_window = sum(circs))

## Now, join the circ_metrics data frame we began with this information about circs in the year window.
circ_metrics <- left_join(circ_metrics, call_number_circs_in_window, by = c("control_number", "call_number", "home_location"))

## Minor fixes so the arithmetic works.
circ_metrics$circs_in_window[is.na(circ_metrics$circs_in_window)] <- "0"
circ_metrics$circs_in_window <- as.integer(circ_metrics$circs_in_window)

## Calculate circs per copy in the window.
circ_metrics <- circ_metrics %>% mutate(raw_circs_per_copy = circs_in_window / copies, circs_per_copy = round(raw_circs_per_copy, 1), busy = round(raw_circs_per_copy / circ_window_years, 1)) %>% select(-raw_circs_per_copy)

write(circ_metrics, circ_metric_file)
#+END_SRC

* Examples

+ [[https://www.library.yorku.ca/find/Record/1000076][A systolic array parallelizing compiler / Ping-Sheng Tseng]]: acquired in 1990, 0 circs.
+ https://www.library.yorku.ca/find/Record/1438201 Two vols, neither circed, but it's not two copies of the same item.
+ [[https://www.library.yorku.ca/find/Record/1172][Captains of consciousness : advertising and the social roots of the consumer culture]], copies at three branches

The volumes problem.



* Commands

+ ~make~ :: ???
+ ~make push_app~ :: use locally to push the Shiny app up to production

* Installation

This is run locally once a year and pushed into production, so there is no cron job.
